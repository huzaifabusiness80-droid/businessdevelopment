// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  
}

// =========================================================
// 1. CORE & AUTHENTICATION (Multi-tenancy)
// =========================================================

model Company {
  id          String   @id @default(cuid())
  name        String
  address     String?
  phone       String?
  email       String?
  website     String?
  taxNumber   String?  @map("tax_number")
  logoUrl     String?  @map("logo_url")
  currency    String   @default("PKR")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       User[]
  roles       Role[]
  customers   Customer[]
  vendors     Vendor[]
  products    Product[]
  categories  Category[]
  brands      Brand[]
  sales       Sale[]
  purchases   Purchase[]
  expenses    Expense[]
  employees   Employee[]
  accounts    Account[]

  @@map("companies")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String 
  email     String?
  fullName  String?  @map("full_name")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  companyId String?  @map("company_id")
  company   Company? @relation(fields: [companyId], references: [id])

  roleId    String? @map("role_id")
  role      Role?   @relation(fields: [roleId], references: [id])

  // Auditing / Relationships
  sales     Sale[]

  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String
  description String?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  companyId   String?  @map("company_id")
  company     Company? @relation(fields: [companyId], references: [id])

  users       User[]
  permissions Permission[]

  @@map("roles")
}

model Permission {
  id        String   @id @default(cuid())
  roleId    String   @map("role_id")
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  module    String
  canView   Boolean  @default(false) @map("can_view")
  canCreate Boolean  @default(false) @map("can_create")
  canEdit   Boolean  @default(false) @map("can_edit")
  canDelete Boolean  @default(false) @map("can_delete")

  @@map("permissions")
}

// =========================================================
// 2. INVENTORY MANAGEMENT
// =========================================================

model Category {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  products  Product[]

  @@map("categories")
}

model Brand {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  companyId String  @map("company_id")
  company   Company @relation(fields: [companyId], references: [id])

  products  Product[]

  @@map("brands")
}

model Product {
  id          String   @id @default(cuid())
  name        String
  sku         String?  // Stock Keeping Unit / Barcode
  description String?
  
  costPrice   Float    @default(0) @map("cost_price")
  sellPrice   Float    @default(0) @map("sell_price")
  stockQty    Int      @default(0) @map("stock_qty")
  alertQty    Int      @default(5) @map("alert_qty")
  
  imageUrl    String?  @map("image_url")
  barcode     String?

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  companyId   String  @map("company_id")
  company     Company @relation(fields: [companyId], references: [id])

  categoryId  String? @map("category_id")
  category    Category? @relation(fields: [categoryId], references: [id])

  brandId     String? @map("brand_id")
  brand       Brand?  @relation(fields: [brandId], references: [id])

  saleItems     SaleItem[]
  purchaseItems PurchaseItem[]

  @@map("products")
}

// =========================================================
// 3. SALES & CRM
// =========================================================

model Customer {
  id          String   @id @default(cuid())
  name        String
  phone       String?
  email       String?
  address     String?
  creditLimit Float    @default(0) @map("credit_limit")
  balance     Float    @default(0) // Positive = Receivable
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  companyId   String  @map("company_id")
  company     Company @relation(fields: [companyId], references: [id])

  sales       Sale[]

  @@map("customers")
}

model Sale {
  id          String   @id @default(cuid())
  invoiceNo   String   @map("invoice_no")
  date        DateTime @default(now())
  
  subTotal    Float    @map("sub_total")
  discount    Float    @default(0)
  tax         Float    @default(0)
  grandTotal  Float    @map("grand_total")
  
  paymentType String   @default("CASH") @map("payment_type") // CASH, CARD, CREDIT
  amountPaid  Float    @default(0) @map("amount_paid")
  change      Float    @default(0)

  status      String   @default("COMPLETED") // COMPLETED, RETURNED

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  companyId   String  @map("company_id")
  company     Company @relation(fields: [companyId], references: [id])

  customerId  String? @map("customer_id")
  customer    Customer? @relation(fields: [customerId], references: [id])

  userId      String? @map("user_id") // Salesman
  user        User?   @relation(fields: [userId], references: [id])

  items       SaleItem[]

  @@map("sales")
}

model SaleItem {
  id        String   @id @default(cuid())
  quantity  Int
  price     Float
  total     Float
  
  saleId    String   @map("sale_id")
  sale      Sale     @relation(fields: [saleId], references: [id])

  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

// =========================================================
// 4. PURCHASES & VENDORS
// =========================================================

model Vendor {
  id          String   @id @default(cuid())
  name        String
  phone       String?
  email       String?
  address     String?
  balance     Float    @default(0) // Positive = Payable
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  companyId   String  @map("company_id")
  company     Company @relation(fields: [companyId], references: [id])

  purchases   Purchase[]

  @@map("vendors")
}

model Purchase {
  id            String   @id @default(cuid())
  invoiceNo     String?  @map("invoice_no") // Vendor Invoice No
  date          DateTime @default(now())
  
  totalAmount   Float    @map("total_amount")
  paidAmount    Float    @default(0) @map("paid_amount")
  status        String   @default("RECEIVED") // ORDERED, RECEIVED

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  companyId     String  @map("company_id")
  company       Company @relation(fields: [companyId], references: [id])

  vendorId      String? @map("vendor_id")
  vendor        Vendor? @relation(fields: [vendorId], references: [id])

  items         PurchaseItem[]

  @@map("purchases")
}

model PurchaseItem {
  id          String   @id @default(cuid())
  quantity    Int
  unitCost    Float    @map("unit_cost")
  total       Float
  
  purchaseId  String   @map("purchase_id")
  purchase    Purchase @relation(fields: [purchaseId], references: [id])

  productId   String   @map("product_id")
  product     Product  @relation(fields: [productId], references: [id])

  @@map("purchase_items")
}

// =========================================================
// 5. ACCOUNTING & EXPENSES
// =========================================================

model Account {
  id          String   @id @default(cuid())
  name        String
  type        String   // ASSET, LIABILITY, INCOME, EXPENSE, EQUITY
  balance     Float    @default(0)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  companyId   String  @map("company_id")
  company     Company @relation(fields: [companyId], references: [id])

  transactions Transaction[]

  @@map("accounts")
}

model Transaction {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  description String?
  debit       Float    @default(0)
  credit      Float    @default(0)
  
  accountId   String   @map("account_id")
  account     Account  @relation(fields: [accountId], references: [id])
  
  @@map("transactions")
}

model Expense {
  id          String   @id @default(cuid())
  title       String
  amount      Float
  date        DateTime @default(now())
  description String?
  category    String?  // E.g., Utility, Rent, Tea
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  companyId   String  @map("company_id")
  company     Company @relation(fields: [companyId], references: [id])

  @@map("expenses")
}

// =========================================================
// 6. HRM & PAYROLL
// =========================================================

model Employee {
  id          String   @id @default(cuid())
  firstName   String   @map("first_name")
  lastName    String?  @map("last_name")
  phone       String?
  designation String?
  salary      Float    @default(0)
  joiningDate DateTime @default(now()) @map("joining_date")
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  companyId   String  @map("company_id")
  company     Company @relation(fields: [companyId], references: [id])

  attendances Attendance[]

  @@map("employees")
}

model Attendance {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  status      String   // PRESENT, ABSENT, LATE, LEAVE
  checkIn     DateTime? @map("check_in")
  checkOut    DateTime? @map("check_out")

  employeeId  String   @map("employee_id")
  employee    Employee @relation(fields: [employeeId], references: [id])

  @@map("attendances")
}